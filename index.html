<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>VoltXSkills</title>
  <meta name="description" content="Learn skills. Support creators. Powered by VoltX." />
  <link rel="manifest" href="application/manifest+json,{'name':'VoltXSkills','short_name':'VoltX','start_url':'/','display':'standalone','background_color':'#0a0a1a','theme_color':'#8A2BE2'}">
  <style>
    :root {
      --volt-purple: #8A2BE2;
      --volt-cyan: #00FFFF;
      --volt-blue: #00BFFF;
      --dark-bg: #0a0a1a;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, var(--dark-bg), #1a1a3a);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      padding: 16px;
    }
    .glow {
      box-shadow: 0 0 15px var(--volt-cyan);
      border-radius: 12px;
    }
    header {
      text-align: center;
      padding: 16px 0;
      margin-bottom: 20px;
    }
    h1 {
      background: linear-gradient(to right, var(--volt-cyan), var(--volt-purple));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-size: 2.2rem;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
    }
    .btn {
      background: var(--volt-purple);
      color: white;
      border: none;
      padding: 14px 24px;
      margin: 10px 0;
      border-radius: 30px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1rem;
      transition: all 0.2s;
      width: 100%;
      max-width: 300px;
    }
    .btn:hover, .btn:active {
      transform: scale(1.02);
      box-shadow: 0 0 20px var(--volt-cyan);
    }
    .hidden { display: none; }
    .video-card {
      background: rgba(20, 20, 40, 0.7);
      border-radius: 16px;
      padding: 16px;
      margin: 16px 0;
      border: 1px solid var(--volt-blue);
    }
    iframe {
      width: 100%;
      height: 280px;
      border-radius: 12px;
      background: black;
      display: block;
    }
    #uploadForm, #feed { max-width: 800px; margin: 0 auto; }
    input[type="text"], input[type="number"], input[type="file"] {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 10px;
      border: 1px solid var(--volt-blue);
      background: rgba(10, 10, 30, 0.7);
      color: white;
      font-size: 1rem;
    }
    input[type="file"]::file-selector-button {
      background: var(--volt-purple);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.8rem; }
      iframe { height: 220px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>‚ö° VoltXSkills</h1>
    <p>Master skills. Support creators. Earn energy.</p>
  </header>

  <!-- Auth Section -->
  <div id="authSection">
    <button id="loginBtn" class="btn glow">üöÄ Sign In with Google</button>
  </div>

  <!-- Upload Section -->
  <div id="uploadSection" class="hidden">
    <h2 style="text-align:center; margin-bottom:16px;">Upload Your Skill Reel</h2>
    <form id="uploadForm">
      <input type="text" id="title" placeholder="Skill title (e.g., 'Build a Web App')" required />
      <input type="number" id="price" placeholder="Price in USD (0 = free)" min="0" step="0.01" value="0" required />
      <!-- ‚úÖ ONLY MP4 ‚Äî no .mov -->
      <input type="file" id="videoFile" accept="video/mp4" required />
      <button type="submit" class="btn glow">üì§ Upload to VoltX</button>
    </form>
  </div>

  <!-- Feed Section -->
  <div id="feed" class="hidden">
    <h2 style="text-align:center; margin-bottom:16px;">üî• Trending Skills</h2>
    <div id="reelsContainer"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    // ‚úÖ FINAL WORKING UPLOAD URL FOR FREE CLOUDFLARE ACCOUNTS
    const CLOUDFLARE_STREAM_UPLOAD_URL = "https://upload.videodelivery.net/6f10d199f5f29f42c2ab94ad3d160130";
    
    // üî• Your verified Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD0fKSpBLzb6rU1xZyHFrGd2YpimbPxmHU",
      authDomain: "voltxskills.firebaseapp.com",
      projectId: "voltxskills",
      storageBucket: "voltxskills.firebasestorage.app",
      messagingSenderId: "883563789061",
      appId: "1:883563789061:web:b0798da0127e74f3d7956c"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM
    const authSec = document.getElementById('authSection');
    const uploadSec = document.getElementById('uploadSection');
    const feedSec = document.getElementById('feed');
    const loginBtn = document.getElementById('loginBtn');
    const uploadForm = document.getElementById('uploadForm');
    const reelsContainer = document.getElementById('reelsContainer');

    // Auth listener
    auth.onAuthStateChanged(user => {
      if (user) {
        authSec.classList.add('hidden');
        uploadSec.classList.remove('hidden');
        feedSec.classList.remove('hidden');
        loadReels();
      } else {
        authSec.classList.remove('hidden');
        uploadSec.classList.add('hidden');
        feedSec.classList.add('hidden');
      }
    });

    // Google Sign-In
    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err => {
        console.error("Login failed:", err);
        alert("Sign-in failed. Try again.");
      });
    };

    // ‚úÖ FINAL MOBILE-SAFE UPLOAD HANDLER (WORKS ON IPHONE)
    uploadForm.onsubmit = async (e) => {
      e.preventDefault();
      
      const fileInput = document.getElementById('videoFile');
      const file = fileInput.files[0]; // ‚úÖ File object, NOT .value
      const title = document.getElementById('title').value.trim();
      const price = parseFloat(document.getElementById('price').value) || 0;

      if (!file) {
        alert("Please select a video file.");
        return;
      }
      
      // ‚úÖ Enforce .mp4 extension (iPhone .mov causes "string pattern" error)
      if (!file.name.toLowerCase().endsWith('.mp4')) {
        alert("Only .mp4 files are allowed. Please convert your video.");
        return;
      }
      
      if (file.size > 50 * 1024 * 1024) {
        alert("Video must be under 50MB.");
        return;
      }
      if (!title) {
        alert("Please enter a title.");
        return;
      }

      try {
        // ‚úÖ Use FormData ‚Äî NO manual Content-Type
        const formData = new FormData();
        formData.append('file', file, file.name); // Cloudflare requires field name 'file'

        const res = await fetch(CLOUDFLARE_STREAM_UPLOAD_URL, {
          method: 'POST',
          body: formData // ‚ö†Ô∏è NO headers ‚Äî let browser handle Content-Type
        });

        if (!res.ok) {
          const text = await res.text();
          console.error("Raw server response:", text);
          throw new Error("Upload failed. Check console.");
        }

        const data = await res.json();
        if (!data.success) {
          console.error("Cloudflare error:", data);
          throw new Error("Cloudflare rejected the upload.");
        }

        const streamUid = data.result.uid;

        // Save to Firestore
        await db.collection('reels').add({
          title,
          price,
          isFree: price <= 0,
          streamUid,
          ownerId: auth.currentUser.uid,
          ownerEmail: auth.currentUser.email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("‚úÖ Reel uploaded successfully!");
        uploadForm.reset();
        loadReels();

      } catch (err) {
        console.error("Upload error:", err);
        alert("Upload failed: " + (err.message || "Unknown error"));
      }
    };

    // Load reels feed
    async function loadReels() {
      reelsContainer.innerHTML = '<p style="text-align:center;">Loading reels...</p>';
      try {
        const snap = await db.collection('reels')
          .orderBy('createdAt', 'desc')
          .limit(20)
          .get();

        if (snap.empty) {
          reelsContainer.innerHTML = '<p style="text-align:center;">No reels yet. Be the first to upload!</p>';
          return;
        }

        reelsContainer.innerHTML = '';
        snap.forEach(doc => {
          const r = doc.data();
          const embedUrl = `https://iframe.videodelivery.net/${r.streamUid}`;
          const card = document.createElement('div');
          card.className = 'video-card glow';
          card.innerHTML = `
            <h3 style="margin:8px 0;">${r.title} ${r.isFree ? '‚ú® Free' : `üí∞ $${r.price.toFixed(2)}`}</h3>
            <p style="font-size:0.9rem; opacity:0.8;">By: ${r.ownerEmail}</p>
            ${r.isFree ? 
              `<iframe src="${embedUrl}" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>` :
              `<button class="btn" onclick="alert('üîì Unlock with Stripe ‚Äî Day 2!')">üîì Unlock for $${r.price.toFixed(2)}</button>`
            }
          `;
          reelsContainer.appendChild(card);
        });
      } catch (err) {
        console.error("Feed load error:", err);
        reelsContainer.innerHTML = '<p style="text-align:center; color:#ff6b6b;">‚ùå Failed to load reels.</p>';
      }
    }
  </script>
</body>
</html>
